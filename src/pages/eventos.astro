---
import Layout from "../layouts/Layout.astro";
import eventsData from "../data/staatsoper-alvaro-events.json";
import EventItem from "../components/EventItem.astro";

function formatDate(dateStr: string) {
  const d = new Date(dateStr);
  return d.toLocaleDateString("es-ES", {
    day: "numeric",
    month: "long",
    year: "numeric",
  });
}

function formatDateShort(dateStr: string) {
  const d = new Date(dateStr);
  const day = d.getDate();
  const month = d.toLocaleDateString("es-ES", { month: "short" });
  return { day: day.toString(), month };
}

const plays = eventsData.plays || [];

// Build plays with sorted occurrences, start/end timestamps and a localized dateRange string
const playsWithRanges = plays.map((play) => {
  const occs = (play.occurrences || [])
    .slice()
    .sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime());
  const first = occs[0];
  const last = occs[occs.length - 1];
  const startTs = first ? new Date(first.date).getTime() : Infinity;
  const endTs = last ? new Date(last.date).getTime() : -Infinity;

  function formatRange(startD: Date | null, endD: Date | null) {
    if (!startD || !endD) return "";
    const sameDay =
      startD.getFullYear() === endD.getFullYear() &&
      startD.getMonth() === endD.getMonth() &&
      startD.getDate() === endD.getDate();

    if (sameDay) {
      const day = startD.getDate();
      const month = startD.toLocaleDateString("es-ES", { month: "long" });
      const year = startD.getFullYear();
      return `${day} de ${month} de ${year}`;
    }

    const sameMonth =
      startD.getMonth() === endD.getMonth() &&
      startD.getFullYear() === endD.getFullYear();
    if (sameMonth) {
      const dayStart = startD.getDate();
      const dayEnd = endD.getDate();
      const month = startD.toLocaleDateString("es-ES", { month: "long" });
      const year = startD.getFullYear();
      return `${dayStart}–${dayEnd} de ${month} de ${year}`;
    }

    // Different months/years -> show compact range
    const s = startD.toLocaleDateString("es-ES", {
      day: "numeric",
      month: "short",
      year: "numeric",
    });
    const e = endD.toLocaleDateString("es-ES", {
      day: "numeric",
      month: "short",
      year: "numeric",
    });
    return `${s} – ${e}`;
  }

  return {
    ...play,
    occurrences: occs,
    startDate: startTs,
    endDate: endTs,
    dateRange: formatRange(
      first ? new Date(first.date) : null,
      last ? new Date(last.date) : null
    ),
    eventUrl: first ? first.eventUrl : "",
  };
});

const startOfToday = (() => {
  const d = new Date();
  d.setHours(0, 0, 0, 0);
  return d.getTime();
})();

// Plays that have any upcoming occurrences
const upcomingPlays = playsWithRanges
  .map((p) => ({
    ...p,
    occurrences: (p.occurrences || []).filter(
      (o) => new Date(o.date).getTime() >= startOfToday
    ),
  }))
  .filter((p) => (p.occurrences || []).length > 0)
  .sort((a, b) => a.startDate - b.startDate);

// Plays with only previous occurrences
const previousPlays = playsWithRanges
  .map((p) => ({
    ...p,
    occurrences: (p.occurrences || []).filter(
      (o) => new Date(o.date).getTime() < startOfToday
    ),
  }))
  .filter((p) => (p.occurrences || []).length > 0)
  .sort((a, b) => b.startDate - a.startDate);
---

<Layout title="Eventos">
  <!-- Hero Section -->
  <div
    class="min-h-[100dvh] bg-[url('../assets/test8.webp')] md:bg-[url('../assets/test7.jpeg')] bg-black/50 bg-blend-overlay bg-cover bg-top flex flex-col justify-end"
  >
    <h2 class="text-5xl text-white pl-20 font-semibold mb-10">Eventos</h2>
  </div>

  <section class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
    <!-- Navigation Tabs -->
    <div class="mb-12">
      <nav
        role="tablist"
        aria-label="Eventos tabs"
        class="flex rounded-lg bg-gray-100 p-1 max-w-md mx-auto"
      >
        <button
          data-tab="upcoming"
          aria-selected="true"
          class="flex-1 px-6 py-3 bg-gray-900 text-white rounded-md font-medium transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-gray-900 focus:ring-offset-2"
        >
          Próximos
        </button>
        <button
          data-tab="previous"
          aria-selected="false"
          class="flex-1 px-6 py-3 text-gray-700 rounded-md font-medium transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-gray-900 focus:ring-offset-2"
        >
          Anteriores
        </button>
      </nav>
    </div>

    <!-- Upcoming panel -->
    <div data-panel="upcoming">
      <div class="text-center mb-12">
        <h2 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4">
          Próximos Eventos
        </h2>
        <p class="text-gray-600 max-w-2xl mx-auto">
          No te pierdas mis próximas actuaciones en algunos de los teatros más
          prestigiosos del mundo.
        </p>
      </div>

      {
        upcomingPlays.length === 0 ? (
          <div class="text-center py-12">
            <p class="text-gray-500 text-lg">
              No hay eventos próximos por ahora.
            </p>
            <p class="text-gray-400 mt-2">
              Vuelve pronto para conocer las próximas fechas.
            </p>
          </div>
        ) : (
          <div class="space-y-6">
            {upcomingPlays.map((event) => (
              <EventItem event={event} actionLabel="Entradas" />
            ))}
          </div>
        )
      }
    </div>

    <!-- Previous panel -->
    <div data-panel="previous" hidden>
      <div class="text-center mb-12">
        <h2 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4">
          Eventos Anteriores
        </h2>
        <p class="text-gray-600 max-w-2xl mx-auto">
          Un recorrido por las actuaciones más destacadas de mi carrera
          artística.
        </p>
      </div>

      {
        previousPlays.length === 0 ? (
          <div class="text-center py-12">
            <p class="text-gray-500 text-lg">
              No hay eventos previos registrados.
            </p>
          </div>
        ) : (
          <div class="space-y-6">
            {previousPlays.map((event) => (
              <EventItem event={event} actionLabel="Info" />
            ))}
          </div>
        )
      }
    </div>
  </section>

  <script type="module">
    const tabButtons = Array.from(document.querySelectorAll("[data-tab]"));
    const panels = Array.from(document.querySelectorAll("[data-panel]"));

    function setActive(tabName) {
      tabButtons.forEach((btn) => {
        const isActive = btn.dataset.tab === tabName;
        btn.setAttribute("aria-selected", isActive ? "true" : "false");
        if (isActive) {
          btn.classList.remove("text-gray-700");
          btn.classList.add("bg-gray-900", "text-white");
        } else {
          btn.classList.remove("bg-gray-900", "text-white");
          btn.classList.add("text-gray-700");
        }
      });

      panels.forEach((panel) => {
        panel.hidden = panel.dataset.panel !== tabName;
      });
    }

    document.addEventListener("click", (e) => {
      const btn = e.target.closest("[data-tab]");
      if (!btn) return;
      setActive(btn.dataset.tab);
    });

    // Initialize with upcoming tab active
    setActive("upcoming");
  </script>
</Layout>
