---
import Layout from "../layouts/Layout.astro";
import eventsData from "../data/staatsoper-alvaro-events.json";

function formatDate(dateStr: string) {
  const d = new Date(dateStr);
  return d.toLocaleDateString("es-ES", {
    day: "numeric",
    month: "long",
    year: "numeric",
  });
}

function formatDateShort(dateStr: string) {
  const d = new Date(dateStr);
  const day = d.getDate();
  const month = d.toLocaleDateString("es-ES", { month: "short" });
  return { day: day.toString(), month };
}

const plays = eventsData.plays || [];

// Build plays with sorted occurrences, start/end timestamps and a localized dateRange string
const playsWithRanges = plays.map((play) => {
  const occs = (play.occurrences || [])
    .slice()
    .sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime());
  const first = occs[0];
  const last = occs[occs.length - 1];
  const startTs = first ? new Date(first.date).getTime() : Infinity;
  const endTs = last ? new Date(last.date).getTime() : -Infinity;

  function formatRange(startD: Date | null, endD: Date | null) {
    if (!startD || !endD) return "";
    const sameMonth =
      startD.getMonth() === endD.getMonth() &&
      startD.getFullYear() === endD.getFullYear();
    if (sameMonth) {
      const dayStart = startD.getDate();
      const dayEnd = endD.getDate();
      const month = startD.toLocaleDateString("es-ES", { month: "long" });
      const year = startD.getFullYear();
      return `${dayStart}–${dayEnd} de ${month} de ${year}`;
    }

    // Different months/years -> show compact range
    const s = startD.toLocaleDateString("es-ES", {
      day: "numeric",
      month: "short",
      year: "numeric",
    });
    const e = endD.toLocaleDateString("es-ES", {
      day: "numeric",
      month: "short",
      year: "numeric",
    });
    return `${s} – ${e}`;
  }

  return {
    ...play,
    occurrences: occs,
    startDate: startTs,
    endDate: endTs,
    dateRange: formatRange(
      first ? new Date(first.date) : null,
      last ? new Date(last.date) : null
    ),
    eventUrl: first ? first.eventUrl : "",
  };
});

const startOfToday = (() => {
  const d = new Date();
  d.setHours(0, 0, 0, 0);
  return d.getTime();
})();

// Plays that have any upcoming occurrences
const upcomingPlays = playsWithRanges
  .map((p) => ({
    ...p,
    occurrences: (p.occurrences || []).filter(
      (o) => new Date(o.date).getTime() >= startOfToday
    ),
  }))
  .filter((p) => (p.occurrences || []).length > 0)
  .sort((a, b) => a.startDate - b.startDate);

// Plays with only previous occurrences
const previousPlays = playsWithRanges
  .map((p) => ({
    ...p,
    occurrences: (p.occurrences || []).filter(
      (o) => new Date(o.date).getTime() < startOfToday
    ),
  }))
  .filter((p) => (p.occurrences || []).length > 0)
  .sort((a, b) => b.startDate - a.startDate);
---

<Layout title="Eventos">
  <!-- Hero Section -->
  <div
    class="min-h-[100dvh] bg-[url('../assets/test8.webp')] md:bg-[url('../assets/test7.jpeg')] bg-black/50 bg-blend-overlay bg-cover bg-top flex flex-col justify-end"
  >
    <h2 class="text-5xl text-white pl-20 font-semibold mb-10">Eventos</h2>
  </div>

  <section class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
    <!-- Navigation Tabs -->
    <div class="mb-12">
      <nav
        role="tablist"
        aria-label="Eventos tabs"
        class="flex rounded-lg bg-gray-100 p-1 max-w-md mx-auto"
      >
        <button
          data-tab="upcoming"
          aria-selected="true"
          class="flex-1 px-6 py-3 bg-gray-900 text-white rounded-md font-medium transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-gray-900 focus:ring-offset-2"
        >
          Próximos
        </button>
        <button
          data-tab="previous"
          aria-selected="false"
          class="flex-1 px-6 py-3 text-gray-700 rounded-md font-medium transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-gray-900 focus:ring-offset-2"
        >
          Anteriores
        </button>
      </nav>
    </div>

    <!-- Upcoming panel -->
    <div data-panel="upcoming">
      <div class="text-center mb-12">
        <h2 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4">
          Próximos Eventos
        </h2>
        <p class="text-gray-600 max-w-2xl mx-auto">
          No te pierdas mis próximas actuaciones en algunos de los teatros más
          prestigiosos del mundo.
        </p>
      </div>

      {
        upcomingPlays.length === 0 ? (
          <div class="text-center py-12">
            <p class="text-gray-500 text-lg">
              No hay eventos próximos por ahora.
            </p>
            <p class="text-gray-400 mt-2">
              Vuelve pronto para conocer las próximas fechas.
            </p>
          </div>
        ) : (
          <div class="space-y-6">
            {upcomingPlays.map((event) => {
              const dateInfo = formatDateShort(event.date);
              return (
                <div class="border-b border-gray-200 pb-6">
                  <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <div class="flex-1">
                      <div class="flex items-center gap-3 mb-2">
                        <h3 class="text-xl font-semibold text-gray-900">
                          {event.title}
                        </h3>
                        <span class="text-sm text-gray-500">
                          {event.composer}
                        </span>
                      </div>
                      <p class="text-gray-600 mb-1">{event.place}</p>
                      <div class="text-xs text-gray-500 space-y-1">
                        {event.role ? <p>Rol: {event.role}</p> : null}
                        {event.stageDirector ? (
                          <p>Dir. Escena: {event.stageDirector}</p>
                        ) : null}
                        {event.musicDirector ? (
                          <p>Dir. Musical: {event.musicDirector}</p>
                        ) : null}
                      </div>
                    </div>
                    <div class="text-right">
                      <p class="text-lg font-medium text-gray-900">
                        {event.dateRange}
                      </p>
                      <div class="flex items-center justify-end gap-3 mt-2">
                        <span class="inline-block px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded">
                          {event.category}
                        </span>
                        {event.eventUrl ? (
                          <a
                            href={event.eventUrl}
                            target="_blank"
                            rel="noopener noreferrer"
                            class="inline-flex items-center px-3 py-1 bg-gray-900 text-white text-xs font-medium rounded hover:bg-gray-800 transition-colors duration-200"
                            aria-label={`Ver evento ${event.title}`}
                          >
                            Entradas
                            <svg
                              class="ml-1 w-3 h-3"
                              fill="none"
                              stroke="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
                              />
                            </svg>
                          </a>
                        ) : null}
                      </div>
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        )
      }
    </div>

    <!-- Previous panel -->
    <div data-panel="previous" hidden>
      <div class="text-center mb-12">
        <h2 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4">
          Eventos Anteriores
        </h2>
        <p class="text-gray-600 max-w-2xl mx-auto">
          Un recorrido por las actuaciones más destacadas de mi carrera
          artística.
        </p>
      </div>

      {
        previousPlays.length === 0 ? (
          <div class="text-center py-12">
            <p class="text-gray-500 text-lg">
              No hay eventos previos registrados.
            </p>
          </div>
        ) : (
          <div class="space-y-6">
            {previousPlays.map((event) => {
              return (
                <div class="border-b border-gray-200 pb-6">
                  <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <div class="flex-1">
                      <div class="flex items-center gap-3 mb-2">
                        <h3 class="text-xl font-semibold text-gray-900">
                          {event.title}
                        </h3>
                        <span class="text-sm text-gray-500">
                          {event.composer}
                        </span>
                      </div>
                      <p class="text-gray-600 mb-1">{event.place}</p>
                      <div class="text-xs text-gray-500 space-y-1">
                        {event.role ? <p>Rol: {event.role}</p> : null}
                        {event.stageDirector ? (
                          <p>Dir. Escena: {event.stageDirector}</p>
                        ) : null}
                        {event.musicDirector ? (
                          <p>Dir. Musical: {event.musicDirector}</p>
                        ) : null}
                      </div>
                    </div>
                    <div class="text-right">
                      <p class="text-lg font-medium text-gray-900">
                        {formatDate(event.date)}
                      </p>
                      <div class="flex items-center justify-end gap-3 mt-2">
                        <span class="inline-block px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded">
                          {event.category}
                        </span>
                        {event.eventUrl ? (
                          <a
                            href={event.eventUrl}
                            target="_blank"
                            rel="noopener noreferrer"
                            class="inline-flex items-center px-3 py-1 bg-gray-900 text-white text-xs font-medium rounded hover:bg-gray-800 transition-colors duration-200"
                            aria-label={`Ver información sobre ${event.title}`}
                          >
                            Info
                            <svg
                              class="ml-1 w-3 h-3"
                              fill="none"
                              stroke="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                              />
                            </svg>
                          </a>
                        ) : null}
                      </div>
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        )
      }
    </div>
  </section>

  <script type="module">
    const tabButtons = Array.from(document.querySelectorAll("[data-tab]"));
    const panels = Array.from(document.querySelectorAll("[data-panel]"));

    function setActive(tabName) {
      tabButtons.forEach((btn) => {
        const isActive = btn.dataset.tab === tabName;
        btn.setAttribute("aria-selected", isActive ? "true" : "false");
        if (isActive) {
          btn.classList.remove("text-gray-700");
          btn.classList.add("bg-gray-900", "text-white");
        } else {
          btn.classList.remove("bg-gray-900", "text-white");
          btn.classList.add("text-gray-700");
        }
      });

      panels.forEach((panel) => {
        panel.hidden = panel.dataset.panel !== tabName;
      });
    }

    document.addEventListener("click", (e) => {
      const btn = e.target.closest("[data-tab]");
      if (!btn) return;
      setActive(btn.dataset.tab);
    });

    // Initialize with upcoming tab active
    setActive("upcoming");
  </script>
</Layout>
